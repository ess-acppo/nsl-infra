---
- name: Copy ddl files
  template:
    src: "{{item.filename}}.j2"
    dest: "/tmp/{{item.filename}}"
  with_items:
    - { filename: "{{ shard_nsl_ddl_file }}" }
    - { filename: mapper-ddl.sql }
    - { filename: mapper-ddlv2.sql }

- postgresql_schema:
    name: mapper
    owner: "{{postgresql_users[1].name}}"
    database: "{{postgresql_databases[0].name}}"
    login_host: 127.0.0.1
    login_user: "{{postgresql_users[1].name}}"
    login_password: "{{postgresql_users[1].password}}"

# Update nsl/mapper schema and tables
- name: Create nsl.public tables, views etc
  become: true
  become_user: postgres
  command: psql -f /tmp/"{{ shard_nsl_ddl_file }}" nsl

- name: Create nsl.mapper tables, views etc
  become: true
  become_user: postgres
  command: psql -f /tmp/mapper-ddlv2.sql nsl

- name: Update nsl.mapper tables, views etc
  become: true
  become_user: postgres
  command: psql -f /tmp/mapper-ddl.sql nsl

# Copy script to postgres home dir
- name: Copy script to postgres home dir
  copy: src=/opt/apache-tomcat-8.5.13/webapps/nxl#services##1.0204/plugins/nsl-domain-plugin-1.10/sql/update-to-25.sql dest=/var/lib/postgresql/update-to-25.sql owner=postgres mode=755 remote_src=yes  

# FIX: mapper.db_version table created, but empty
- name: Create an entry in mapper.db_version table
  become: true
  become_user: postgres
  command: psql "{{postgresql_databases[0].name}}" -c 'INSERT INTO mapper.db_version (id, version) VALUES (1, 5);'

# FIX: always make sure the mapper point to the localhost mapper
- name: Make the mapper point to the localhost mapper
  become: true
  become_user: postgres
  command: psql "{{postgresql_databases[0].name}}" -c 'INSERT INTO mapper.host (id, host_name, preferred) VALUEs (1, '\''localhost:7070/nsl-mapper'\'', true) ON CONFLICT (id) DO NOTHING;'

# FIX: editor, add missing property
# - name: Add missing property in rails configuration
#   become: true
#   become_user: tomcat
#   command: echo 'Rails.configuration.nsl_linker = "http://localhost:7070/nsl-mapper/"' >> "{{tomcat_dir}}"/.nsl/editor-config.rb
- name: Add line in editor-config.rb for editor rails property
  lineinfile:
    dest: "{{tomcat_dir}}/.nsl/editor-config.rb"
    line: 'Rails.configuration.nsl_linker = "http://localhost:7070/nsl-mapper/"'
    insertafter: 'EOF'
    regexp: 'Rails.configuration.nsl_linker = "http://localhost:7070/nsl-mapper/"'
    state: present

# Upgrade cb version to 25
- name: Upgrade the database version to 25
  become: true
  become_user: postgres
  command: psql "{{postgresql_databases[0].name}}" -f /var/lib/postgresql/update-to-25.sql

# Cat the editor-config.rb file
- name: Print the editor config file
  become: true
  become_user: tomcat
  command: cat "{{tomcat_dir}}/.nsl/editor-config.rb"

# Restart tomcat
- name: tomcat-8-restart
  service: name=tomcat state=restarted

# Echo variable {{tomcat_dir}}
- name: echo variable
  command: echo {{tomcat_dir}}